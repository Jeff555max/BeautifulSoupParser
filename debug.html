import requests
from bs4 import BeautifulSoup
import pandas as pd
from urllib.parse import urljoin

# Конфигурация
BASE_URL = 'http://185.244.219.162/phpmyadmin/'
LOGIN_URL = urljoin(BASE_URL, 'index.php')
DB_NAME = 'testDB'
TABLE_NAME = 'users'
USERNAME = 'test'
PASSWORD = 'JHFBdsyf2eg8*'

# Инициализация сессии
session = requests.Session()
session.headers.update({
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
    'Connection': 'keep-alive'
})

try:
    # 1. Получаем начальную страницу для токена и cookies
    print("1. Получение начальной страницы...")
    response = session.get(BASE_URL)
    response.raise_for_status()

    # Сохраняем для отладки
    with open('debug_initial.html', 'w', encoding='utf-8') as f:
        f.write(response.text)

    # 2. Парсим форму авторизации
    soup = BeautifulSoup(response.text, 'html.parser')
    login_form = soup.find('form', {'id': 'login_form'})
    if not login_form:
        raise Exception("Форма авторизации не найдена!")

    # 3. Собираем все необходимые данные для авторизации
    form_data = {
        'pma_username': USERNAME,
        'pma_password': PASSWORD,
        'server': '1',
        'target': 'index.php'
    }

    # Добавляем все скрытые поля из формы
    for hidden in login_form.find_all('input', type='hidden'):
        if hidden.get('name'):
            form_data[hidden['name']] = hidden.get('value', '')

    print("2. Собранные данные формы:", {k: v for k, v in form_data.items() if k != 'pma_password'})

    # 4. Отправляем запрос на авторизацию
    print("3. Отправка данных авторизации...")
    login_headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Referer': BASE_URL,
        'Origin': BASE_URL.rstrip('/')
    }

    response = session.post(
        LOGIN_URL,
        headers=login_headers,
        data=form_data,
        allow_redirects=True
    )
    response.raise_for_status()

    # Сохраняем ответ для отладки
    with open('debug_auth_response.html', 'w', encoding='utf-8') as f:
        f.write(response.text)

    # 5. Проверяем успешность авторизации
    if 'pma_navigation' not in response.text:
        error_msg = "Авторизация не удалась!"
        soup = BeautifulSoup(response.text, 'html.parser')
        error_div = soup.find('div', class_='error')
        if error_div:
            error_msg += f" Сервер сообщает: {error_div.get_text(strip=True)}"
        raise Exception(error_msg)

    print("4. Авторизация успешна!")

    # 6. Получаем данные таблицы
    print("5. Получение данных таблицы...")
    table_url = urljoin(BASE_URL, f'tbl_sql.php?db={DB_NAME}&table={TABLE_NAME}')
    response = session.get(table_url)
    response.raise_for_status()

    # Сохраняем для отладки
    with open('debug_table_page.html', 'w', encoding='utf-8') as f:
        f.write(response.text)

    # 7. Парсим таблицу с данными
    soup = BeautifulSoup(response.text, 'html.parser')
    table = soup.find('table', id='table_results') or soup.find('table', class_='table_results')

    if not table:
        raise Exception("Таблица с данными не найдена")

    # Извлекаем заголовки
    headers = [th.get_text(strip=True) for th in table.find('thead').find_all('th')]

    # Извлекаем данные
    rows = []
    for tr in table.find('tbody').find_all('tr'):
        cells = [td.get_text(strip=True) for td in tr.find_all('td')]
        if cells:
            rows.append(dict(zip(headers, cells)))

    # Выводим результат
    if rows:
        df = pd.DataFrame(rows)
        print("\nДанные таблицы users:")
        print(df.to_string(index=False))

        # Сохраняем в Excel
        df.to_excel('users_data.xlsx', index=False)
        print("\nДанные сохранены в users_data.xlsx")
    else:
        print("Таблица пуста")

except requests.exceptions.RequestException as e:
    print(f"\nОшибка сети: {e}")
except Exception as e:
    print(f"\nОшибка: {e}")
finally:
    # Сохраняем cookies для анализа
    print("\nCookies сессии:")
    for cookie in session.cookies:
        print(f"{cookie.name}: {cookie.value}")